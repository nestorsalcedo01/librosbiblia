<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuestionario: Libros de la Biblia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0e7ff; 
            color: #374151; 
        }
        .quiz-container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        .quiz-container:hover {
            transform: translateY(-5px);
        }
        .question-text {
            color: #1e3a8a; 
        }
        .option-button {
            background-color: #f0f4f8;
            border: 2px solid #d1d5db; 
            color: #374151;
            transition: all 0.2s ease-in-out;
            border-radius: 8px;
            cursor: pointer;
        }
        .option-button:hover:not(:disabled) {
            background-color: #3b82f6; 
            color: white;
            border-color: #2563eb;
        }
        .option-button.selected-for-multi {
            background-color: #60a5fa; /* Azul más claro para selección múltiple */
            color: white;
            border-color: #3b82f6;
        }
        .option-button.correct {
            background-color: #10b981 !important; 
            color: white !important;
            border-color: #059669 !important;
        }
        .option-button.incorrect {
            background-color: #ef4444 !important; 
            color: white !important;
            border-color: #dc2626 !important;
        }
        .option-button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        .feedback-text {
            min-height: 48px; /* Aumentado para más info */
            font-size: 0.9rem;
        }
        .book-info {
            background-color: #eef2ff; /* Fondo índigo muy claro para info del libro */
            color: #312e81; /* Texto índigo oscuro */
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85rem;
            border-left: 3px solid #4f46e5;
        }
        .progress-bar-bg {
            background-color: #e5e7eb; 
            border-radius: 9999px;
        }
        .progress-bar-fill {
            background-color: #3b82f6; 
            border-radius: 9999px;
            transition: width 0.3s ease-in-out;
        }
        .start-button, .next-button, .restart-button, .confirm-multi-button {
            background-color: #4f46e5; 
            color: white;
            transition: background-color 0.2s ease;
            border-radius: 8px;
        }
        .start-button:hover, .next-button:hover, .restart-button:hover, .confirm-multi-button:hover {
            background-color: #4338ca; 
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center justify-center min-h-screen">

    <div id="quiz-app" class="quiz-container w-full max-w-3xl p-6 md:p-8"> {/* Aumentado max-w */}
        
        <div id="start-screen" class="text-center">
            <h1 class="text-3xl font-bold text-indigo-700 mb-4">Cuestionario de los Libros de la Biblia</h1>
            <p class="text-gray-700 mb-6">Pon a prueba tus conocimientos sobre los libros, sus categorías y su orden. ¡Buena suerte!</p>
            <img src="https://placehold.co/300x200/e0e7ff/4f46e5?text=La+Biblia" alt="Ilustración decorativa de la Biblia" class="mx-auto mb-6 rounded-lg shadow-md" onerror="this.src='https://placehold.co/300x200/cccccc/333333?text=Imagen+no+disponible'">
            <button id="start-button" class="start-button w-full sm:w-auto px-8 py-3 text-lg font-semibold">Comenzar Cuestionario</button>
        </div>

        <div id="quiz-screen" class="hidden">
            <div class="mb-6">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-sm text-gray-600">Pregunta <span id="current-question-number"></span> de <span id="total-questions"></span></p>
                    <p class="text-sm font-semibold text-indigo-600">Puntuación: <span id="score">0</span></p>
                </div>
                <div class="progress-bar-bg w-full h-3">
                    <div id="progress-bar" class="progress-bar-fill h-full" style="width: 0%;"></div>
                </div>
            </div>

            <h2 id="question-text" class="question-text text-xl md:text-2xl font-semibold mb-6 min-h-[60px]">Cargando pregunta...</h2>
            
            <div id="options-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                </div>
            
            <button id="confirm-multi-button" class="confirm-multi-button w-full px-6 py-3 font-semibold hidden mb-4">Confirmar Selección</button>

            <div id="feedback-text" class="feedback-text text-center font-semibold mb-6"></div>

            <button id="next-button" class="next-button w-full px-6 py-3 font-semibold hidden">Siguiente Pregunta</button>
        </div>

        <div id="end-screen" class="hidden text-center">
            <h1 class="text-3xl font-bold text-indigo-700 mb-4">¡Cuestionario Completado!</h1>
            <img src="https://placehold.co/200x150/e0e7ff/4f46e5?text=¡Felicidades!" alt="Ilustración de felicitaciones" class="mx-auto mb-6 rounded-lg shadow-md" onerror="this.src='https://placehold.co/200x150/cccccc/333333?text=Imagen+no+disponible'">
            <p class="text-xl text-gray-700 mb-2">Tu puntuación final es:</p>
            <p id="final-score" class="text-4xl font-bold text-indigo-600 mb-6"></p>
            <p id="final-message" class="text-gray-600 mb-8"></p>
            <button id="restart-button" class="restart-button w-full sm:w-auto px-8 py-3 text-lg font-semibold">Jugar de Nuevo</button>
        </div>
    </div>

    <footer class="text-center mt-8 py-4">
        <p class="text-sm text-gray-500">&copy; <span id="year"></span> Cuestionario Bíblico Interactivo.</p>
    </footer>

    <script>
        // --- DATOS DE LOS LIBROS ---
        const booksData = [
            // Antiguo Testamento
            { name: "Génesis", category: "Pentateuco", order: 1, info: "Origen del universo, la humanidad, el pecado y el pueblo de Israel a través de los patriarcas." },
            { name: "Éxodo", category: "Pentateuco", order: 2, info: "Liberación de Israel de Egipto, entrega de la Ley en el Sinaí y construcción del Tabernáculo." },
            { name: "Levítico", category: "Pentateuco", order: 3, info: "Leyes ceremoniales, sacrificios y pureza para Israel, enfatizando la santidad de Dios." },
            { name: "Números", category: "Pentateuco", order: 4, info: "Censo y peregrinaje de Israel por el desierto, sus rebeliones y preparación para Canaán." },
            { name: "Deuteronomio", category: "Pentateuco", order: 5, info: "Discursos de Moisés repasando la Ley e instando a la obediencia antes de entrar a la Tierra Prometida." },
            { name: "Josué", category: "Históricos (AT)", order: 6, info: "Conquista y división de la Tierra Prometida bajo el liderazgo de Josué." },
            { name: "Jueces", category: "Históricos (AT)", order: 7, info: "Ciclos de pecado, opresión y liberación de Israel a través de líderes llamados jueces." },
            { name: "Rut", category: "Históricos (AT)", order: 8, info: "Historia de lealtad y redención en tiempos de los jueces, mostrando el linaje de David." },
            { name: "1 Samuel", category: "Históricos (AT)", order: 9, info: "Transición a la monarquía, con el profeta Samuel y los reinados de Saúl y David." },
            { name: "2 Samuel", category: "Históricos (AT)", order: 10, info: "Reinado de David, sus triunfos, pecados y establecimiento de Jerusalén como capital." },
            { name: "1 Reyes", category: "Históricos (AT)", order: 11, info: "Reinado de Salomón, construcción del Templo y división del reino (Israel y Judá)." },
            { name: "2 Reyes", category: "Históricos (AT)", order: 12, info: "Historia de los reinos divididos, sus reyes y el exilio de Israel y Judá." },
            { name: "1 Crónicas", category: "Históricos (AT)", order: 13, info: "Recuento de la historia desde Adán hasta David, con enfoque en el linaje davídico y el Templo." },
            { name: "2 Crónicas", category: "Históricos (AT)", order: 14, info: "Reinado de Salomón e historia del reino de Judá, hasta el decreto de Ciro." },
            { name: "Esdras", category: "Históricos (AT)", order: 15, info: "Regreso de los exiliados de Babilonia y reconstrucción del Templo." },
            { name: "Nehemías", category: "Históricos (AT)", order: 16, info: "Reconstrucción de las murallas de Jerusalén y reforma espiritual del pueblo." },
            { name: "Ester", category: "Históricos (AT)", order: 17, info: "Una joven judía reina de Persia salva a su pueblo, mostrando la providencia de Dios." },
            { name: "Job", category: "Sapienciales y Poéticos", order: 18, info: "Explora el sufrimiento de los justos y la soberanía de Dios." },
            { name: "Salmos", category: "Sapienciales y Poéticos", order: 19, info: "Colección de 150 cánticos, oraciones y poemas para la adoración y la vida devocional." },
            { name: "Proverbios", category: "Sapienciales y Poéticos", order: 20, info: "Dichos sabios para vivir una vida justa y piadosa en el temor de Dios." },
            { name: "Eclesiastés", category: "Sapienciales y Poéticos", order: 21, info: "Reflexión sobre el significado de la vida 'debajo del sol' y el temor a Dios." },
            { name: "Cantar de los Cantares", category: "Sapienciales y Poéticos", order: 22, info: "Poema que celebra el amor matrimonial, también interpretado alegóricamente." },
            { name: "Isaías", category: "Profetas Mayores", order: 23, info: "Profecías sobre juicio, restauración y detalladas predicciones mesiánicas." },
            { name: "Jeremías", category: "Profetas Mayores", order: 24, info: "Llamado al arrepentimiento ante la inminente caída de Judá y la promesa de un nuevo pacto." },
            { name: "Lamentaciones", category: "Profetas Mayores", order: 25, info: "Poemas que lamentan la destrucción de Jerusalén y el Templo." },
            { name: "Ezequiel", category: "Profetas Mayores", order: 26, info: "Profecías a los exiliados sobre la santidad de Dios, la responsabilidad y la restauración futura." },
            { name: "Daniel", category: "Profetas Mayores", order: 27, info: "Experiencias en cortes paganas y visiones proféticas sobre imperios y el reino de Dios." },
            { name: "Oseas", category: "Profetas Menores", order: 28, info: "Metáfora del matrimonio del profeta para ilustrar el amor de Dios por el Israel infiel." },
            { name: "Joel", category: "Profetas Menores", order: 29, info: "Describe una plaga de langostas como juicio y promete la efusión del Espíritu." },
            { name: "Amós", category: "Profetas Menores", order: 30, info: "Denuncia la injusticia social, la idolatría y la complacencia en Israel." },
            { name: "Abdías", category: "Profetas Menores", order: 31, info: "Profecía del juicio de Edom por su hostilidad hacia Judá." },
            { name: "Jonás", category: "Profetas Menores", order: 32, info: "Historia del profeta reacio, mostrando la misericordia de Dios hacia todas las naciones." },
            { name: "Miqueas", category: "Profetas Menores", order: 33, info: "Denuncia la injusticia y profetiza la caída, pero también la venida del Mesías de Belén." },
            { name: "Nahúm", category: "Profetas Menores", order: 34, info: "Profetiza la destrucción de Nínive como juicio divino por su crueldad." },
            { name: "Habacuc", category: "Profetas Menores", order: 35, info: "Diálogo sobre la justicia divina, aprendiendo a confiar en Dios." },
            { name: "Sofonías", category: "Profetas Menores", order: 36, info: "Advierte sobre el 'día del Señor' y ofrece esperanza de restauración." },
            { name: "Hageo", category: "Profetas Menores", order: 37, info: "Anima a los judíos retornados a reconstruir el Templo." },
            { name: "Zacarías", category: "Profetas Menores", order: 38, info: "Visiones simbólicas y profecías sobre la reconstrucción, Israel y el Mesías." },
            { name: "Malaquías", category: "Profetas Menores", order: 39, info: "Confronta la apatía religiosa y profetiza la venida de Elías antes del día del Señor." },
            // Nuevo Testamento
            { name: "Mateo", category: "Evangelios", order: 40, info: "Presenta a Jesús como el Mesías Rey, cumpliendo las profecías del Antiguo Testamento." },
            { name: "Marcos", category: "Evangelios", order: 41, info: "Describe a Jesús como el Siervo sufriente y poderoso, enfatizando sus acciones." },
            { name: "Lucas", category: "Evangelios", order: 42, info: "Retrata a Jesús como el Salvador de toda la humanidad, con énfasis en los marginados." },
            { name: "Juan", category: "Evangelios", order: 43, info: "Revela la divinidad de Jesús como el Hijo de Dios, a través de señales y discursos." },
            { name: "Hechos de los Apóstoles", category: "Histórico (NT)", order: 44, info: "Narra el nacimiento y la expansión de la iglesia primitiva por obra del Espíritu Santo." },
            { name: "Romanos", category: "Cartas Paulinas", order: 45, info: "Exposición detallada de la justificación por la fe y la vida en el Espíritu." },
            { name: "1 Corintios", category: "Cartas Paulinas", order: 46, info: "Aborda problemas doctrinales y prácticos en la iglesia de Corinto." },
            { name: "2 Corintios", category: "Cartas Paulinas", order: 47, info: "Defensa del apostolado de Pablo y llamado a la reconciliación y generosidad." },
            { name: "Gálatas", category: "Cartas Paulinas", order: 48, info: "Defiende la justificación por la fe sola, contra la legalismo judaizante." },
            { name: "Efesios", category: "Cartas Paulinas", order: 49, info: "Describe la iglesia como el cuerpo de Cristo y la unidad de los creyentes en Él." },
            { name: "Filipenses", category: "Cartas Paulinas", order: 50, info: "Carta de gozo y gratitud, animando a la humildad y unidad en Cristo." },
            { name: "Colosenses", category: "Cartas Paulinas", order: 51, info: "Exalta la supremacía y suficiencia de Cristo frente a falsas enseñanzas." },
            { name: "1 Tesalonicenses", category: "Cartas Paulinas", order: 52, info: "Anima a los creyentes sobre la segunda venida de Cristo y la vida santa." },
            { name: "2 Tesalonicenses", category: "Cartas Paulinas", order: 53, info: "Aclara enseñanzas sobre la segunda venida y exhorta a la perseverancia." },
            { name: "1 Timoteo", category: "Cartas Paulinas", order: 54, info: "Instrucciones para el liderazgo, la adoración y la conducta en la iglesia." },
            { name: "2 Timoteo", category: "Cartas Paulinas", order: 55, info: "Última carta de Pablo, animando a Timoteo a la fidelidad y perseverancia en el ministerio." },
            { name: "Tito", category: "Cartas Paulinas", order: 56, info: "Instrucciones para establecer el orden y el liderazgo en las iglesias de Creta." },
            { name: "Filemón", category: "Cartas Paulinas", order: 57, info: "Petición personal de Pablo a Filemón para que perdone y restaure a su esclavo Onésimo." },
            { name: "Hebreos", category: "Cartas Generales", order: 58, info: "Demuestra la superioridad de Cristo y el nuevo pacto sobre el antiguo." },
            { name: "Santiago", category: "Cartas Generales", order: 59, info: "Enfatiza la importancia de las obras como evidencia de una fe genuina." },
            { name: "1 Pedro", category: "Cartas Generales", order: 60, info: "Anima a los creyentes a vivir santamente en medio del sufrimiento y la persecución." },
            { name: "2 Pedro", category: "Cartas Generales", order: 61, info: "Advierte contra los falsos maestros y exhorta al crecimiento espiritual." },
            { name: "1 Juan", category: "Cartas Generales", order: 62, info: "Asegura a los creyentes su comunión con Dios y define las marcas de un verdadero cristiano." },
            { name: "2 Juan", category: "Cartas Generales", order: 63, info: "Advierte contra apoyar a los falsos maestros y exhorta a caminar en la verdad y el amor." },
            { name: "3 Juan", category: "Cartas Generales", order: 64, info: "Elogia a Gayo por su hospitalidad y condena la oposición de Diótrefes." },
            { name: "Judas", category: "Cartas Generales", order: 65, info: "Exhorta a contender ardientemente por la fe contra las falsas enseñanzas." },
            { name: "Apocalipsis", category: "Profético (NT)", order: 66, info: "Revelación de Jesucristo sobre los eventos finales, la victoria de Cristo y la nueva creación." }
        ];

        const categories = [
            "Pentateuco", "Históricos (AT)", "Sapienciales y Poéticos", 
            "Profetas Mayores", "Profetas Menores", "Evangelios", 
            "Histórico (NT)", "Cartas Paulinas", "Cartas Generales", "Profético (NT)"
        ];

        const TOTAL_QUESTIONS = 20; // Aumentado para más variedad
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = [];
        let userSelections = []; // Para preguntas de selección múltiple ordenada

        // --- ELEMENTOS DEL DOM ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const endScreen = document.getElementById('end-screen');
        const startButton = document.getElementById('start-button');
        const nextButton = document.getElementById('next-button');
        const restartButton = document.getElementById('restart-button');
        const confirmMultiButton = document.getElementById('confirm-multi-button');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const feedbackTextEl = document.getElementById('feedback-text');
        const scoreEl = document.getElementById('score');
        const currentQuestionNumberEl = document.getElementById('current-question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const progressBarEl = document.getElementById('progress-bar');
        const finalScoreEl = document.getElementById('final-score');
        const finalMessageEl = document.getElementById('final-message');

        document.getElementById('year').textContent = new Date().getFullYear();

        // --- MANEJADORES DE EVENTOS ---
        startButton.addEventListener('click', startQuiz);
        nextButton.addEventListener('click', loadNextQuestion);
        restartButton.addEventListener('click', startQuiz);
        confirmMultiButton.addEventListener('click', handleConfirmMultiSelection);

        // --- LÓGICA DEL CUESTIONARIO ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getBookInfo(bookName) {
            const book = booksData.find(b => b.name === bookName);
            return book ? `<div class="book-info"><strong>${book.name}:</strong> ${book.info}</div>` : '';
        }
        
        function getCategoryInfo(categoryName) {
            // Podríamos añadir descripciones a las categorías si se desea.
            // Por ahora, solo devolvemos el nombre.
            return `<div class="book-info">Categoría: <strong>${categoryName}</strong></div>`;
        }


        function generateQuestions() {
            questions = [];
            const availableBooks = [...booksData];
            shuffleArray(availableBooks);

            for (let i = 0; i < TOTAL_QUESTIONS; i++) {
                const questionTypeRoll = Math.random(); // 0 a 1
                let questionData;

                if (questionTypeRoll < 0.25) { // Tipo 1: ¿A qué categoría pertenece X? (25%)
                    const book = availableBooks[i % availableBooks.length];
                    const correctAnswer = book.category;
                    let wrongAnswersPool = categories.filter(cat => cat !== correctAnswer);
                    shuffleArray(wrongAnswersPool);
                    const options = shuffleArray([correctAnswer, ...wrongAnswersPool.slice(0, 3)]);
                    questionData = {
                        text: `¿A qué categoría pertenece el libro de <strong>${book.name}</strong>?`,
                        options: options.slice(0,4),
                        answer: correctAnswer,
                        correctBookName: book.name, // Para mostrar info
                        type: 'category_of_book'
                    };
                } else if (questionTypeRoll < 0.5) { // Tipo 2: ¿Qué libro viene después de X? (25%)
                    let bookIndex;
                    let book;
                    do { bookIndex = Math.floor(Math.random() * (booksData.length - 1)); 
                         book = booksData[bookIndex];
                    } while (book.order >= booksData.length); // Asegurar que no sea el último por orden
                    
                    const correctAnswer = booksData.find(b => b.order === book.order + 1)?.name;
                    if (!correctAnswer) { // Fallback si algo va mal con el orden
                        i--; continue; 
                    }

                    let wrongAnswers = [];
                    let tempBooks = shuffleArray([...booksData]);
                    for(let b of tempBooks) {
                        if (b.name !== correctAnswer && b.name !== book.name && wrongAnswers.length < 3) {
                            wrongAnswers.push(b.name);
                        }
                    }
                    const options = shuffleArray([correctAnswer, ...wrongAnswers]);
                     questionData = {
                        text: `¿Qué libro viene después de <strong>${book.name}</strong>?`,
                        options: options.slice(0,4),
                        answer: correctAnswer,
                        type: 'book_after_book'
                    };
                } else if (questionTypeRoll < 0.75) { // Tipo 3: Categoría de Múltiples Libros (25%)
                    const category = categories[Math.floor(Math.random() * categories.length)];
                    let booksInCat = booksData.filter(b => b.category === category);
                    shuffleArray(booksInCat);
                    if (booksInCat.length >= 2) { // Necesitamos al menos 2 libros
                        const selectedBooks = booksInCat.slice(0, Math.random() < 0.5 && booksInCat.length >=3 ? 3 : 2); // 2 o 3 libros
                        const bookNames = selectedBooks.map(b => `<strong>${b.name}</strong>`).join(', ');
                        
                        let wrongAnswersPool = categories.filter(cat => cat !== category);
                        shuffleArray(wrongAnswersPool);
                        const options = shuffleArray([category, ...wrongAnswersPool.slice(0, 3)]);

                        questionData = {
                            text: `Los libros ${bookNames} pertenecen a la categoría de:`,
                            options: options.slice(0,4),
                            answer: category,
                            booksInQuestion: selectedBooks.map(b => b.name), // Para info
                            type: 'category_of_multiple_books'
                        };
                    } else { i--; continue; } // No suficientes libros en categoría, reintentar
                
                } else { // Tipo 4: Selecciona DOS libros en orden DESPUÉS de X (25%)
                    let bookIndex;
                    let book;
                     // Asegurar que no sea uno de los dos últimos por orden
                    do { bookIndex = Math.floor(Math.random() * (booksData.length - 2));
                         book = booksData[bookIndex];
                    } while (book.order >= booksData.length - 1);

                    const correctAnswer1 = booksData.find(b => b.order === book.order + 1)?.name;
                    const correctAnswer2 = booksData.find(b => b.order === book.order + 2)?.name;

                    if (!correctAnswer1 || !correctAnswer2) { i--; continue; } // Fallback

                    let wrongAnswers = [];
                    let tempBooks = shuffleArray([...booksData]);
                    for(let b of tempBooks) {
                        if (b.name !== correctAnswer1 && b.name !== correctAnswer2 && b.name !== book.name && wrongAnswers.length < 3) {
                            wrongAnswers.push(b.name);
                        }
                    }
                    const options = shuffleArray([correctAnswer1, correctAnswer2, ...wrongAnswers.slice(0,2)]); // Asegurar 4-5 opciones
                     questionData = {
                        text: `Selecciona en orden los DOS libros que vienen DESPUÉS de <strong>${book.name}</strong>. (Haz clic en el primero, luego en el segundo y confirma)`,
                        options: options.slice(0,5), // Dar 5 opciones para más desafío
                        answer: [correctAnswer1, correctAnswer2],
                        type: 'select_two_ordered_after_book'
                    };
                }
                if(questionData) questions.push(questionData);
                else { i--; } // Si no se generó pregunta, reintentar
            }
        }


        function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            userSelections = [];
            scoreEl.textContent = score;
            generateQuestions();
            totalQuestionsEl.textContent = TOTAL_QUESTIONS;
            
            startScreen.classList.add('hidden');
            endScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            nextButton.classList.add('hidden');
            confirmMultiButton.classList.add('hidden');
            
            loadNextQuestion();
        }

        function loadNextQuestion() {
            userSelections = [];
            if (currentQuestionIndex < TOTAL_QUESTIONS) {
                showQuestion(questions[currentQuestionIndex]);
                currentQuestionNumberEl.textContent = currentQuestionIndex + 1;
                progressBarEl.style.width = `${((currentQuestionIndex + 1) / TOTAL_QUESTIONS) * 100}%`;
                feedbackTextEl.innerHTML = ''; // Limpiar feedback
                feedbackTextEl.className = 'feedback-text text-center font-semibold mb-6'; 
                nextButton.classList.add('hidden');
                confirmMultiButton.classList.add('hidden');
                 if (questions[currentQuestionIndex].type === 'select_two_ordered_after_book') {
                    // No mostrar confirm button inicialmente para este tipo, se activa al seleccionar
                }
            } else {
                showEndScreen();
            }
        }

        function showQuestion(question) {
            questionTextEl.innerHTML = question.text; 
            optionsContainerEl.innerHTML = '';

            question.options.forEach(optionText => {
                const button = document.createElement('button');
                button.textContent = optionText;
                button.classList.add('option-button', 'p-4', 'text-left', 'w-full', 'font-medium');
                
                if (question.type === 'select_two_ordered_after_book') {
                    button.addEventListener('click', () => handleMultiSelectOption(button, optionText, question));
                } else {
                    button.addEventListener('click', () => selectAnswer(button, optionText, question));
                }
                optionsContainerEl.appendChild(button);
            });
        }

        function handleMultiSelectOption(button, optionText, question) {
            if (userSelections.length < 2 && !button.classList.contains('selected-for-multi')) {
                userSelections.push(optionText);
                button.classList.add('selected-for-multi');
                button.disabled = true; // Deshabilitar para no volver a seleccionar el mismo
            }
            
            if (userSelections.length === 2) {
                // Habilitar todos los botones de opción para posible cambio antes de confirmar
                // O simplemente mostrar el botón de confirmar
                confirmMultiButton.classList.remove('hidden');
                 optionsContainerEl.querySelectorAll('.option-button').forEach(btn => {
                    if (!btn.classList.contains('selected-for-multi')) btn.disabled = true;
                });
            }
        }
        
        function handleConfirmMultiSelection() {
            const question = questions[currentQuestionIndex];
            if (userSelections.length === 2 && question.type === 'select_two_ordered_after_book') {
                let isCorrect = userSelections[0] === question.answer[0] && userSelections[1] === question.answer[1];
                let feedbackHtml = '';

                if (isCorrect) {
                    score++;
                    scoreEl.textContent = score;
                    feedbackHtml = '<span class="text-green-600">¡Correcto!</span>';
                } else {
                    feedbackHtml = `<span class="text-red-600">Incorrecto.</span> El orden correcto era: <strong>${question.answer[0]}</strong>, luego <strong>${question.answer[1]}</strong>.`;
                }
                feedbackHtml += getBookInfo(question.answer[0]);
                feedbackHtml += getBookInfo(question.answer[1]);
                feedbackTextEl.innerHTML = feedbackHtml;

                // Marcar visualmente las opciones
                optionsContainerEl.querySelectorAll('.option-button').forEach(btn => {
                    btn.disabled = true;
                    if (question.answer.includes(btn.textContent)) { // Si es parte de la respuesta correcta
                        if (userSelections.includes(btn.textContent) && userSelections.indexOf(btn.textContent) === question.answer.indexOf(btn.textContent) ) {
                             // Si el usuario lo seleccionó y en la posición correcta
                            if (btn.textContent === question.answer[0] || btn.textContent === question.answer[1]) btn.classList.add('correct');
                        } else if (userSelections.includes(btn.textContent)) {
                            // Si el usuario lo seleccionó pero en la posición incorrecta o no era parte
                            btn.classList.add('incorrect');
                        } else if (btn.textContent === question.answer[0] || btn.textContent === question.answer[1]) {
                            // No lo seleccionó el usuario pero era correcto (para destacar)
                             btn.classList.add('correct'); // Podría ser un estilo diferente para "respuesta correcta no elegida"
                        }
                    } else if (userSelections.includes(btn.textContent)) { // Seleccionado por el usuario pero incorrecto
                        btn.classList.add('incorrect');
                    }
                });


                currentQuestionIndex++;
                nextButton.classList.remove('hidden');
                confirmMultiButton.classList.add('hidden');
            }
        }


        function selectAnswer(button, selectedOption, question) {
            const buttons = optionsContainerEl.querySelectorAll('.option-button');
            buttons.forEach(btn => btn.disabled = true);

            const correctAnswer = question.answer;
            let feedbackHtml = '';

            if (selectedOption === correctAnswer) {
                score++;
                scoreEl.textContent = score;
                button.classList.add('correct');
                feedbackHtml = '<span class="text-green-600">¡Correcto!</span>';
            } else {
                button.classList.add('incorrect');
                buttons.forEach(btn => { if (btn.textContent === correctAnswer) btn.classList.add('correct'); });
                feedbackHtml = `<span class="text-red-600">Incorrecto.</span> La respuesta era: <strong>${correctAnswer}</strong>.`;
            }

            // Mostrar información adicional
            if (question.type === 'category_of_book') {
                feedbackHtml += getBookInfo(question.correctBookName);
            } else if (question.type === 'book_after_book') {
                feedbackHtml += getBookInfo(correctAnswer); // Info del libro que era la respuesta
            } else if (question.type === 'category_of_multiple_books') {
                feedbackHtml += getCategoryInfo(correctAnswer);
                question.booksInQuestion.forEach(bookName => feedbackHtml += getBookInfo(bookName));
            }
            
            feedbackTextEl.innerHTML = feedbackHtml;
            currentQuestionIndex++;
            nextButton.classList.remove('hidden');
        }

        function showEndScreen() {
            quizScreen.classList.add('hidden');
            endScreen.classList.remove('hidden');
            finalScoreEl.textContent = `${score} de ${TOTAL_QUESTIONS}`;

            let message = "";
            const percentage = (score / TOTAL_QUESTIONS) * 100;
            if (percentage === 100) message = "¡Excelente! ¡Conoces muy bien los libros de la Biblia!";
            else if (percentage >= 70) message = "¡Muy bien! Sigue practicando para perfeccionar tus conocimientos.";
            else if (percentage >= 50) message = "¡Buen intento! Un poco más de práctica y lo dominarás.";
            else message = "Sigue estudiando, ¡seguro mejorarás mucho!";
            finalMessageEl.textContent = message;
        }
    </script>
</body>
</html>
